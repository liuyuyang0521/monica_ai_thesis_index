# Cookieè·¨åŸŸé—®é¢˜ä¿®å¤æ€»ç»“

## ğŸ¯ é—®é¢˜

`LoginContextHolder.getUserId()` è¿”å› `null`

## ğŸ” æ ¹æœ¬åŸå› 

**Cookieè·¨åŸŸä¼ é€’å¤±è´¥** - ä»£ç†æœåŠ¡å™¨æ²¡æœ‰æ­£ç¡®è½¬å‘Cookieï¼Œå¯¼è‡´ï¼š
1. ç™»å½•ååç«¯è®¾ç½®çš„ `SESSION_ID` Cookie æ— æ³•ä¼ é€’åˆ°å‰ç«¯æµè§ˆå™¨
2. åç»­APIè¯·æ±‚æ— æ³•æºå¸¦ `SESSION_ID` Cookie åˆ°åç«¯
3. åç«¯æ‹¦æˆªå™¨æ— æ³•ä»Cookieä¸­è·å–Sessionï¼Œå¯¼è‡´ `LoginContextHolder.getUserId()` è¿”å› `null`

## âœ… è§£å†³æ–¹æ¡ˆ

### ä¿®æ”¹çš„æ–‡ä»¶ï¼ˆå·²åŒæ­¥å‰¯æœ¬å’ŒçœŸå®é¡¹ç›®ï¼‰

#### 1. proxy-server.js
**ä½ç½®ï¼š**
- `monica_ai_thesis_index/test-cursor/proxy-server.js`
- `D:\Work\monica_ai_thesis_index\test-cursor\proxy-server.js`

**ä¿®æ”¹ï¼š**
```javascript
// âœ… è½¬å‘å‰ç«¯Cookieåˆ°åç«¯
if (req.headers.cookie) {
  headers['Cookie'] = req.headers.cookie;
}

// âœ… è½¬å‘åç«¯Set-Cookieåˆ°å‰ç«¯
if (proxyRes.headers['set-cookie']) {
  responseHeaders['Set-Cookie'] = proxyRes.headers['set-cookie'];
}

// âœ… å…è®¸æºå¸¦Cookieçš„CORSé…ç½®
'Access-Control-Allow-Origin': 'http://localhost:3000',  // ä¸èƒ½ç”¨ *
'Access-Control-Allow-Credentials': 'true'
```

#### 2. api.js
**ä½ç½®ï¼š**
- `monica_ai_thesis_index/test-cursor/api.js`
- `D:\Work\monica_ai_thesis_index\test-cursor\api.js`

**ä¿®æ”¹ï¼š**
```javascript
// æ”¹ä¸ºä½¿ç”¨ä»£ç†æœåŠ¡å™¨
const API_BASE_URL = 'http://localhost:3000/api';
```

#### 3. login.js
**ä½ç½®ï¼š**
- `monica_ai_thesis_index/test-cursor/login.js`
- `D:\Work\monica_ai_thesis_index\test-cursor\login.js`

**ä¿®æ”¹ï¼š**
```javascript
// æ”¹ä¸ºä½¿ç”¨ä»£ç†æœåŠ¡å™¨
const API_BASE_URL = 'http://localhost:3000/api';
```

## ğŸ“‹ ä½¿ç”¨æ–¹æ³•

### 1. å¯åŠ¨åç«¯æœåŠ¡
ç¡®ä¿åç«¯è¿è¡Œåœ¨ `http://47.243.255.193:8080`

### 2. å¯åŠ¨ä»£ç†æœåŠ¡å™¨
```bash
cd D:\Work\monica_ai_thesis_index\test-cursor
node proxy-server.js
```

### 3. è®¿é—®å‰ç«¯
âš ï¸ **é‡è¦ï¼šå¿…é¡»é€šè¿‡ä»£ç†è®¿é—®**
- âœ… æ­£ç¡®ï¼š`http://localhost:3000/login.html`
- âŒ é”™è¯¯ï¼šç›´æ¥åŒå‡»æ‰“å¼€HTMLæ–‡ä»¶

## ğŸ§ª éªŒè¯æ­¥éª¤

1. æ‰“å¼€æµè§ˆå™¨å¼€å‘è€…å·¥å…· (F12)
2. è®¿é—® `http://localhost:3000/login.html`
3. ç™»å½•ç³»ç»Ÿ
4. æ£€æŸ¥ Console æ—¥å¿—ï¼Œåº”è¯¥æ˜¾ç¤ºï¼š
   ```
   âœ… Set-Cookieå¤´: SESSION_ID=xxx
   å½“å‰é¡µé¢æ‰€æœ‰cookie: SESSION_ID=xxx
   ```
5. æ£€æŸ¥ Network â†’ Response Headersï¼š
   ```
   Set-Cookie: SESSION_ID=xxx; Path=/; Max-Age=7200; HttpOnly
   ```
6. æ£€æŸ¥ Application â†’ Cookies â†’ `http://localhost:3000`
   - åº”è¯¥çœ‹åˆ° `SESSION_ID` Cookie
7. è®¿é—®éœ€è¦ç™»å½•çš„é¡µé¢ï¼ˆå¦‚ä»»åŠ¡ä¸­å¿ƒï¼‰ï¼Œä¸åº”è¯¥å‡ºç°"æœªç™»å½•"é”™è¯¯

## ğŸ“Š ä¿®æ”¹å‰åå¯¹æ¯”

### ä¿®æ”¹å‰
```
å‰ç«¯(localhost:5500) --X--> åç«¯(47.243.255.193:8080)
                     è·¨åŸŸCookieæ— æ³•ä¼ é€’
é—®é¢˜ï¼š
- âŒ ç™»å½•åCookieä¸ä¿å­˜
- âŒ åç»­è¯·æ±‚æ²¡æœ‰Cookie
- âŒ getUserId() è¿”å›null
```

### ä¿®æ”¹å
```
å‰ç«¯(localhost:3000) --âœ“--> ä»£ç†(localhost:3000) --âœ“--> åç«¯(47.243.255.193:8080)
                      Cookieæ­£å¸¸ä¼ é€’         Cookieæ­£å¸¸è½¬å‘
ä¼˜åŠ¿ï¼š
- âœ… ç™»å½•åCookieæ­£å¸¸ä¿å­˜
- âœ… åç»­è¯·æ±‚è‡ªåŠ¨æºå¸¦Cookie
- âœ… getUserId() æ­£å¸¸è¿”å›ç”¨æˆ·ID
```

## ğŸ”§ æŠ€æœ¯åŸç†

### ä¸ºä»€ä¹ˆä¸èƒ½ç›´æ¥è·¨åŸŸä¼ é€’Cookieï¼Ÿ

1. **æµè§ˆå™¨çš„åŒæºç­–ç•¥**ï¼šä¸åŒåŸŸå/ç«¯å£ä¸èƒ½å…±äº«Cookie
2. **CORSé™åˆ¶**ï¼š
   - `Access-Control-Allow-Origin: *` æ—¶ä¸èƒ½æºå¸¦Cookie
   - å¿…é¡»æŒ‡å®šå…·ä½“åŸŸåï¼Œå¦‚ `http://localhost:3000`
   - å¿…é¡»è®¾ç½® `Access-Control-Allow-Credentials: true`

### ä»£ç†æœåŠ¡å™¨çš„ä½œç”¨

1. å‰ç«¯å’Œä»£ç†æœåŠ¡å™¨åŒåŸŸï¼ˆéƒ½æ˜¯ `localhost:3000`ï¼‰
2. Cookieåœ¨æµè§ˆå™¨çš„ `localhost:3000` åŸŸä¸‹æ­£å¸¸ä¿å­˜
3. ä»£ç†æœåŠ¡å™¨è´Ÿè´£è½¬å‘Cookieåˆ°çœŸå®åç«¯
4. é¿å…äº†å‰åç«¯è·¨åŸŸCookieä¼ é€’é—®é¢˜

## ğŸ“ åç«¯ä»£ç è¯´æ˜

### Cookieè®¾ç½®ä½ç½®
`monica_ai_thesis/thesis-users/src/main/java/com/example/users/service/impl/UserServiceImpl.java`

```java
private void setSessionCookie(HttpServletResponse response, String sessionId) {
    Cookie cookie = new Cookie(SessionConstant.SESSION_COOKIE_NAME, sessionId);
    cookie.setHttpOnly(true);    // é˜²XSSæ”»å‡»
    cookie.setPath("/");         // å…¨ç«™æœ‰æ•ˆ
    cookie.setMaxAge((int) SessionConstant.SESSION_EXPIRE_TIME);  // 2å°æ—¶
    response.addCookie(cookie);
}
```

### æ‹¦æˆªå™¨ä½ç½®
`monica_ai_thesis/thesis-common/src/main/java/com/example/common/interceptor/LoginInterceptor.java`

```java
public boolean preHandle(HttpServletRequest request, HttpServletResponse response, Object handler) {
    // 1. ä»Cookieä¸­è·å–Session ID
    String sessionId = getSessionIdFromCookie(request);
    
    // 2. æ ¹æ®Session IDè·å–ç™»å½•ä¸Šä¸‹æ–‡
    LoginContext loginContext = sessionService.getSession(sessionId);
    
    // 3. å°†ç™»å½•ä¿¡æ¯å­˜å…¥ThreadLocal
    LoginContextHolder.set(loginContext);
    
    return true;
}
```

## ğŸš€ ä¸‹ä¸€æ­¥ï¼ˆå¯é€‰ä¼˜åŒ–ï¼‰

### ç”Ÿäº§ç¯å¢ƒéƒ¨ç½²å»ºè®®

1. **ä½¿ç”¨Nginxåå‘ä»£ç†**
   ```nginx
   location /api/ {
       proxy_pass http://47.243.255.193:8080/api/;
       proxy_set_header Cookie $http_cookie;
   }
   ```

2. **ç»Ÿä¸€åŸŸå**
   - å‰ç«¯ï¼š`https://your-domain.com`
   - åç«¯APIï¼š`https://your-domain.com/api`
   - ä¸éœ€è¦ä»£ç†æœåŠ¡å™¨

3. **å¯ç”¨HTTPS**
   - è®¾ç½® `cookie.setSecure(true)`
   - å¢å¼ºå®‰å…¨æ€§

## ğŸ“š å‚è€ƒæ–‡æ¡£

è¯¦ç»†æ–‡æ¡£è¯·æŸ¥çœ‹ï¼š`COOKIE_FIX_README.md`

## âœ… å®ŒæˆçŠ¶æ€

- âœ… åˆ†æCookieè·¨åŸŸä¼ é€’é—®é¢˜çš„æ ¹æœ¬åŸå› 
- âœ… ä¿®æ”¹ä»£ç†æœåŠ¡å™¨ï¼Œæ­£ç¡®è½¬å‘Cookie
- âœ… ä¿®æ”¹å‰ç«¯é…ç½®ï¼Œä½¿ç”¨ä»£ç†æœåŠ¡å™¨
- âœ… åŒæ­¥ä¿®æ”¹workç›®å½•ä¸­çš„çœŸå®é¡¹ç›®ä»£ç 
- âœ… åˆ›å»ºè¯¦ç»†çš„ä¿®å¤æ–‡æ¡£å’Œä½¿ç”¨è¯´æ˜

**é—®é¢˜å·²è§£å†³ï¼** ğŸ‰

